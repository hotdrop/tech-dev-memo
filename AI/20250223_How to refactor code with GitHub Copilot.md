# How to refactor code with GitHub Copilot」
- GitHub Blog
- https://github.blog/ai-and-ml/github-copilot/how-to-refactor-code-with-github-copilot/

# 内容
この記事は`GitHub Copilot`を使ってリファクタリングをスムーズに進めるというのが記事の主題。
要約とするには長すぎるので内容を整理してまとめる。ただ、ChatGPTとやりとりしながら要約しているのでかなり噛み砕いて表現している箇所あり。

## リファクタリングのアプローチ
コードの動作を知らないまま改善しようとすると意図せず動作を壊す可能性がある。記事では`getSound()`例を載せており一見「switchにしたほうがいい」と考えがちだが、その前にこのコードの処理フローがどう動くのかを正しく理解することが大事とのこと。
そこでCopilotの`/explain`コマンドを使うことでコードの流れを手早く確認できる。特に、大規模なコードベースで関数が複数のファイルにまたがっている場合には、コードリーディングの時間を大幅に短縮できる可能性がある。

とりあえずCopilotに「このコードをどう改善できますか？」と聞いてみるアプローチは試しやすい。しかし曖昧な質問の仕方だと意図しない改善提案が出ることもあるという点に気をつける。

また、Copilotの提案は100%信用しない。`GitHub Copilot`をアシスタントと呼んでいる通り、これはスキルの代わりではなく能力を増強するためのもの。生成AIを使う場合全般の注意だが必ずレビューなど確認プロセスを挟むことが大事

## リファクタリングの計画を立てることの重要性
リファクタリングの際、無計画に手を動かすと途中で破綻する可能性が高いため、目標を決め目標に沿って進めることが大事である。
例えば以下のような目標を考える
- 可読性の向上（変数名や関数名を明確にする、コードを短くする）
- 重複コードの削減（共通モジュールを作る）
- ネストの削減（入れ子構造をフラットにする）

このあたりは、Copilotに具体的な指示を与えることで効果的にサポートさせることができる。
Copilotへの適切な指示の例は元記事参照のこと。
（元記事では「JSファイル全体をスキャンして`GitHub API`コールを管理するクラスを作成して」などとしている）
「ネストを減らす」「コードを短くする」「安全性チェック＋コメント追加」 という複数の指示を一括で出す例も乗っている。

## Copilotを使った大規模リファクタリングの実例
実際の大規模なコードベースで、複数の異なる組織向けにカスタマイズされたシステムを統一・再利用可能な形にリファクタリングするというリアルなケースを紹介している。この事例で重要なポイントは以下の通り。
1. モジュール化（複数の組織で再利用可能にする）
2. メンテナビリティ（コードを整理・ドキュメント化）
3. カスタマイズ性（各組織の要件に適応可能に）
4. コーディング規約の遵守（一貫性を持たせる）

この4つの目標を定めて、Copilotを活用しながらリファクタリングしたとのこと。
これ以降はこの4つをどうアプローチしていったか具体的なプロンプトと回答が載っている。

## 簡単にStep1〜4までまとめ
`ChatGPT 4o`にまとめてもらった。
- Step1: 共通モジュールの作成
  - `gh-migrations`を作り`GitHub API`の処理を一元管理した。これによりコードの分散を防ぎ、再利用性を向上。
- Step2: 主要エンティティのクラス化
  - `MigrationIssue`や`BatchIssue`などを作成し、データ構造を整理。オブジェクト指向的な設計でメンテナンスしやすいコードになった。
- Step3: カプセル化と責務の明確化
  - クラスが自身の状態を管理し、クライアントコードをシンプルにした。Factoryパターンを導入し、インスタンスの作成方法を統一してエンティティの責務を明確化し、コードの一貫性を向上
- Step4: クライアントコードの整理
  - `gh-migrations`を活用して冗長なコードを削除し、全体をリファクタリング。コードがシンプルになり、メンテナンス性と可読性が向上。

## まとめ
リファクタリングは簡単なケースもあれば、大規模なコードベースを相手にすると「どこから手をつければいいのか分からない」という状況になりがちである。そんなときに大切なのは焦らず基本に立ち返ること。
- まずはコードベースの理解を深めることが最優先
- 全体を把握できれば、どこをどうリファクタリングすべきか見えてくる
- GitHub Copilotを活用して、アイデアを具体的なコードに落とし込む

## このブログからの学び
- 無計画に進めると途中で破綻する可能性が高い。まずはコードの全体像を把握しどの部分を改善するか明確にするのが重要
- `Copilot`はコードの改善案を提案できるが、最終的な判断は開発者自身が行うべき。特に大規模なリファクタリングでは、Copilotの提案を適切に取捨選択することが鍵になる
- リファクタリングは一気にやろうとせず、シンプルなリファクタリング（if文の整理、関数分割など）から始めるのが有効。大きなコードベースでも、徐々に整えていけば着実に改善できる
- 「どこから手をつければいいか分からない」と感じたら、Copilotに相談するのも手。「このコードをどう改善できる？」 と尋ねることで、新しい視点が得られることもある。