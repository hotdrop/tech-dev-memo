# Kotlin Constants in Android: Top-level vs. Companion-enclosed
AndroidDagashiの2月9日の記事より
- URL: https://proandroiddev.com/top-level-constants-vs-companion-enclosed-constants-using-kotlin-in-android-cbb067732428

# 要約
`Companion object`に定数を作ると余計な`Companion`クラスが生成されクラスロード時に無駄なオブジェクトが作られる。R8が削除できないので（極小だが）APKサイズやメモリが無駄に増加してしまう。
一方でトップレベル定数の場合は無駄なKtクラスが作られるものの参照されないクラスになるようで、R8が削除してくれるため余計なオーバーヘッドがないとのこと。まとめると以下のとおり。

1. 1ファイル内で定数を使う場合はトップレベル定数にする
2. 複数のクラスで共有する場合は、専用のファイルでトップレベル定数を定義
3. グループ化したい場合は`object`を使ってそこに定数を定義する
  - ただし、R8で最適化（`object`クラスを削除する）ためには定数だけ参照し`object`自体を参照しないこと。

→2と3の違いがよくわからなかったので最後に追記

# D8とR8の影響の違い
D8とR8は名前が似ているがそもそも役割が別で同列に語るものではないのでD8についておさらい。

## D8とは
D8はAndroid用の新しいdexコンパイラで、従来の`Dalvik Exevutable Compiler`に代わるものでKotlin/Javaバイトコードをdexバイトコードに変換する役割を担う。従来のコンパイラより高速・高効率に変換を行なってくれる。2017年くらいからD8がデフォルトになっているようだ。

## R8とは
Proguradの後継ツールで不要なコードの削除/最適化やコードの圧縮・最適化を行うツール。dexバイトコードに対してR8が最適化をしてくれる。`isMinifyEnabled = true`にすると有効になる。

## D8とR8の影響まとめ
1. D8はJavaバイトコードをDalvikバイトコードに変換するが、特に最適化はしない。
2. R8はコードの縮小（シュリンク）を行うので、未使用のクラスは削除される。
3. トップレベル定数を持つ`MainActivityKt`クラスは参照されていないためR8によって削除される。
4. 一方`Companion object`に含めた定数は`Companion`クラスに残るが、それ自体が`MainActivity`から参照されているため削除されない。
5. つまり`Companion object`に定数を置くと、R8によって削除されず余計なクラスが増える可能性がある。

# よくわからなかかった点
要約で列挙した2と3がよくわからなかったので調査した。

1. 1ファイル内で定数を使う場合はトップレベル定数にする
2. 複数のクラスで共有する場合は、専用のファイルでトップレベル定数を定義
3. グループ化したい場合は`object`を使ってそこに定数を定義する

1ファイル内で定数を使う場合はそのファイルのトップレベル定数として定義すれば良い。しかし、もしその定数を他のクラスから参照したい場合、他のクラスが定数を参照してしまうと"他のクラスからKtクラスが参照されてしまう"という状態を作り出してしまい、結果KtファイルがR8で削除対象にならない、となってしまう。それを回避するため2か3の選択肢が浮上する。

2と3は1とは違い「2を採用した後、ある条件になったら3の方が有益」というものではなく「2と3は可読性の違い」となる。
「専用クラスを作成する」＝「objectを使う」ではない。

例えばトップレベル定数を専用ファイルに定義するとこうなる。
```kotlin
// ApiConstants.kt
package com.example.constants

const val BASE_URL = "https://api.example.com"
const val TIMEOUT = 30L
```

ここに定数を列挙していくと、昔のJavaコードでよく見られた定数クラスが出来上がる。懐かしい。
今時は機能やレイヤーでパッケージに分かれているのでそれ用の`Constants.kt`を作っても良いが、ある程度意味的にまとまっている定数をまとめたいケースもあり、それをグループ化と表現している。
グループ化する必要がなければトップレベル定数でよいし意味的にまとめたければ`object`を使う。
